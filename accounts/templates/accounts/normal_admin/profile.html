{% extends "accounts/normal_admin/base.html" %}
{% load static %}

{% block title %}Profile - Normal Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Admin Profile</h1>
            <p class="text-muted">Manage your account settings and preferences</p>
        </div>
        <div class="text-end">
            <small class="text-muted">Last login: {{ user.last_login|date:"M d, Y H:i" }}</small>
        </div>
    </div>

    <!-- Profile Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Account Information</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Basic Information</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Username:</strong></td>
                                    <td>{{ user.username }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ user.email }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Full Name:</strong></td>
                                    <td>{{ user.get_full_name|default:"Not set" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>{{ user.phone_number|default:"Not set" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>User Type:</strong></td>
                                    <td>
                                        <span class="badge bg-primary">{{ user.user_type|title }}</span>
                                        {% if user.is_admin_active %}
                                            <span class="badge bg-success">Active Admin</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Account Status</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Account Status:</strong></td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Verification:</strong></td>
                                    <td>
                                        {% if user.is_verified %}
                                            <span class="badge bg-success">Verified</span>
                                        {% else %}
                                            <span class="badge bg-warning">Unverified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Member Since:</strong></td>
                                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Last Login:</strong></td>
                                    <td>{{ user.last_login|date:"M d, Y H:i" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Login Count:</strong></td>
                                    <td>{{ user.login_count }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Profile Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Update Profile Information</h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="profile">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name"
                                           value="{{ user.first_name }}" placeholder="Enter first name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name"
                                           value="{{ user.last_name }}" placeholder="Enter last name">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone_number" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number"
                                           value="{{ user.phone_number }}" placeholder="Enter phone number">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address"
                                           value="{{ user.address }}" placeholder="Enter address">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="bio" class="form-label">Bio / About</label>
                            <textarea class="form-control" id="bio" name="bio" rows="3"
                                      placeholder="Tell us about yourself">{{ user.bio }}</textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Profile
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Form -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">Change Password</h6>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="password">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current_password" name="current_password"
                                           required placeholder="Enter current password">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new_password" name="new_password"
                                           required placeholder="Enter new password" minlength="8">
                                    <div class="form-text">Password must be at least 8 characters long.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                                           required placeholder="Confirm new password">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Permissions Display -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Your Admin Access Control</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-users"></i> User Management</h5>
                            <div class="mb-3">
                                <span class="badge bg-{{ permissions.manage_users|yesno:'success,secondary' }} fs-6">
                                    <i class="fas fa-{{ permissions.manage_users|yesno:'check,times' }}"></i>
                                    {{ permissions.manage_users|yesno:'ENABLED,DISABLED' }}
                                </span>
                                <p class="text-muted small mt-1">Can view and manage regular users (buyers, agents, brokers)</p>
                                {% if not permissions.manage_users %}
                                    <a href="{% url 'normal_admin:normal_admin_request_permission' %}?perm=manage_users" class="btn btn-sm btn-outline-primary mt-1">
                                        <i class="fas fa-plus"></i> Request Access
                                    </a>
                                {% endif %}
                            </div>
                            <div>
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-times"></i> DISABLED
                                </span>
                                <p class="text-muted small mt-1">Manage other admins (Super Admin Only)</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-home"></i> Property Management</h5>
                            <div class="mb-3">
                                <span class="badge bg-{{ permissions.manage_properties|yesno:'success,secondary' }} fs-6">
                                    <i class="fas fa-{{ permissions.manage_properties|yesno:'check,times' }}"></i>
                                    {{ permissions.manage_properties|yesno:'ENABLED,DISABLED' }}
                                </span>
                                <p class="text-muted small mt-1">Can verify/approve property listings</p>
                            </div>
                            <div class="mb-3">
                                <span class="badge bg-{{ permissions.manage_premium|yesno:'success,secondary' }} fs-6">
                                    <i class="fas fa-{{ permissions.manage_premium|yesno:'check,times' }}"></i>
                                    {{ permissions.manage_premium|yesno:'ENABLED,DISABLED' }}
                                </span>
                                <p class="text-muted small mt-1">Can manage premium features and subscriptions</p>
                            </div>
                            <div>
                                <span class="badge bg-secondary fs-6">
                                    <i class="fas fa-times"></i> DISABLED
                                </span>
                                <p class="text-muted small mt-1">System settings and configuration (Super Admin Only)</p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="fas fa-envelope"></i> Inquiry Management</h5>
                            <div>
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check"></i> ENABLED
                                </span>
                                <p class="text-muted small mt-1">Can view and resolve customer inquiries</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="fas fa-chart-bar"></i> Reporting</h5>
                            <div>
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check"></i> ENABLED
                                </span>
                                <p class="text-muted small mt-1">Can view activity reports and statistics</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-4" role="alert">
                        <h6><i class="fas fa-info-circle"></i> Permission Management</h6>
                        <p class="mb-0">
                            Your permissions are controlled by the Super Admin. If you need access to additional features,
                            please contact the Super Admin to request permission changes. All permission changes are logged for security.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Password confirmation validation
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;

    if (newPassword !== confirmPassword) {
        this.setCustomValidity('Passwords do not match');
    } else {
        this.setCustomValidity('');
    }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const formType = this.querySelector('input[name="form_type"]').value;

    if (formType === 'password') {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('New passwords do not match!');
            return false;
        }

        if (newPassword.length < 8) {
            e.preventDefault();
            alert('Password must be at least 8 characters long!');
            return false;
        }
    }
});
</script>
{% endblock %}
