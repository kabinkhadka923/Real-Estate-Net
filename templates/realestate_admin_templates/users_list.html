{% extends 'realestate_admin_templates/base_admin.html' %}
{% load static %}

{% block title %}Users ‚Ä¢ Admin{% endblock %}

{% block page_heading %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0" style="color: #0033A0; font-weight: 700;">üë• User Management</h3>
  <small class="text-muted">Manage registered users and accounts</small>
</div>
{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h5 class="mb-0">All Users ({{ total_users }})</h5>
    <small class="text-muted">Manage user accounts, permissions, and access</small>
  </div>
  <div class="d-flex gap-2">
    <button class="btn" style="background: linear-gradient(135deg, #DC143C, #0033A0); color: white; border: none;" onclick="exportUsers()">
      <i class="fas fa-download me-1"></i>Export CSV
    </button>
    <button class="btn btn-success" onclick="showBulkActions()">
      <i class="fas fa-tasks me-1"></i>Bulk Actions
    </button>
  </div>
</div>

<!-- Bulk Actions Bar (Hidden by default) -->
<div id="bulk-actions-bar" class="card mb-3" style="display: none; background: linear-gradient(135deg, #0033A0, #DC143C); color: white;">
  <div class="card-body py-2">
    <div class="row align-items-center">
      <div class="col-md-8">
        <span id="selected-count">0 users selected</span>
      </div>
      <div class="col-md-4 text-end">
        <button class="btn btn-light btn-sm me-2" onclick="bulkVerify()">
          <i class="fas fa-check me-1"></i>Verify
        </button>
        <button class="btn btn-warning btn-sm me-2" onclick="bulkBan()">
          <i class="fas fa-ban me-1"></i>Ban
        </button>
        <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
          <i class="fas fa-times me-1"></i>Clear
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Users Table -->
<div class="card">
  <div class="card-header" style="background: linear-gradient(135deg, #0033A0, #DC143C); color: white;">
    <h6 class="mb-0"><i class="fas fa-users me-2"></i>Registered Users</h6>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table id="users-table" class="table table-hover table-striped">
        <thead style="background: rgba(0, 51, 160, 0.1);">
          <tr>
            <th width="40">
              <input type="checkbox" id="select-all" class="form-check-input">
            </th>
            <th width="60">ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Type</th>
            <th>Status</th>
            <th>Properties</th>
            <th>Joined</th>
            <th width="150">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr data-user-id="{{ user.id }}">
            <td>
              <input type="checkbox" class="user-checkbox form-check-input" value="{{ user.id }}">
            </td>
            <td>
              <strong>#{{ user.id }}</strong>
            </td>
            <td>
              <div class="d-flex align-items-center">
                {% if user.avatar %}
                  <img src="{{ user.avatar.url }}" alt="Avatar" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                {% else %}
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                    {{ user.username|slice:":1"|upper }}
                  </div>
                {% endif %}
                <div>
                  <strong>{{ user.username }}</strong>
                  {% if user.get_full_name %}
                    <br><small class="text-muted">{{ user.get_full_name }}</small>
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              {{ user.email }}
              {% if user.email_verified %}
                <i class="fas fa-check-circle text-success ms-1" title="Email Verified"></i>
              {% endif %}
            </td>
            <td>
              <span class="badge" style="background: linear-gradient(135deg, #0033A0, #DC143C); color: white;">
                {% if user.user_type == 'broker' %}
                  üè¢ Broker
                {% elif user.user_type == 'agent' %}
                  üë§ Agent
                {% elif user.user_type == 'buyer' %}
                  üí∞ Buyer
                {% else %}
                  {{ user.user_type|title }}
                {% endif %}
              </span>
            </td>
            <td>
              {% if user.is_active %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-danger">Banned</span>
              {% endif %}
              {% if user.is_verified %}
                <br><small class="text-success"><i class="fas fa-shield-alt me-1"></i>Verified</small>
              {% endif %}
              {% if user.is_premium_user %}
                <br><small class="text-warning"><i class="fas fa-star me-1"></i>Premium</small>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-info">{{ user.properties.count }}</span>
            </td>
            <td>
              <small>{{ user.date_joined|date:"M d, Y" }}</small>
              <br><small class="text-muted">{{ user.date_joined|timesince }}</small>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a href="{% url 'admin_user_detail' user.id %}" class="btn btn-outline-primary btn-sm" title="View Details">
                  <i class="fas fa-eye"></i>
                </a>
                {% if user.is_active %}
                  <button class="btn btn-outline-danger btn-sm" onclick="banUser({{ user.id }})" title="Ban User">
                    <i class="fas fa-ban"></i>
                  </button>
                {% else %}
                  <button class="btn btn-outline-success btn-sm" onclick="unbanUser({{ user.id }})" title="Unban User">
                    <i class="fas fa-check"></i>
                  </button>
                {% endif %}
                {% if not user.is_verified %}
                  <button class="btn btn-outline-info btn-sm" onclick="verifyUser({{ user.id }})" title="Verify User">
                    <i class="fas fa-shield-alt"></i>
                  </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center py-4">
              <i class="fas fa-users fa-2x text-muted mb-2"></i>
              <p class="text-muted">No users found</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- User Statistics Cards -->
<div class="row mt-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div style="font-size: 2em; color: #0033A0;">üë•</div>
        <h5 class="card-title">{{ total_users }}</h5>
        <p class="card-text text-muted">Total Users</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div style="font-size: 2em; color: #DC143C;">üè¢</div>
        <h5 class="card-title">{{ users|length }}</h5>
        <p class="card-text text-muted">Active Users</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div style="font-size: 2em; color: #28a745;">üíé</div>
        <h5 class="card-title">{{ users|length }}</h5>
        <p class="card-text text-muted">Premium Users</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <div style="font-size: 2em; color: #ffc107;">üÜï</div>
        <h5 class="card-title">{{ users|length }}</h5>
        <p class="card-text text-muted">New This Month</p>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Initialize DataTable
$(document).ready(function() {
    $('#users-table').DataTable({
        responsive: true,
        pageLength: 25,
        language: {
            search: "Search users:",
            lengthMenu: "Show _MENU_ users per page",
            info: "Showing _START_ to _END_ of _TOTAL_ users",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        columnDefs: [
            { orderable: false, targets: [0, 8] } // Disable sorting on checkbox and actions columns
        ],
        initComplete: function() {
            // Add fade-in animation
            $('.table').addClass('fade-in');
        }
    });
});

// Bulk selection handling
$('#select-all').on('change', function() {
    $('.user-checkbox').prop('checked', this.checked);
    updateBulkActionsVisibility();
});

$(document).on('change', '.user-checkbox', function() {
    updateBulkActionsVisibility();
});

function updateBulkActionsVisibility() {
    const checkedBoxes = $('.user-checkbox:checked');
    const bulkActionsBar = $('#bulk-actions-bar');
    const selectedCount = $('#selected-count');

    if (checkedBoxes.length > 0) {
        bulkActionsBar.show();
        selectedCount.text(`${checkedBoxes.length} user${checkedBoxes.length > 1 ? 's' : ''} selected`);
    } else {
        bulkActionsBar.hide();
    }
}

function showBulkActions() {
    $('#select-all').prop('checked', true).trigger('change');
}

// User action functions
function banUser(userId) {
    if (confirm('Are you sure you want to ban this user? They will lose access to their account.')) {
        ajaxPost(`/admin/api/user/ban/`, { id: userId }, function() {
            location.reload();
        });
    }
}

function unbanUser(userId) {
    if (confirm('Are you sure you want to unban this user? They will regain access to their account.')) {
        ajaxPost(`/admin/api/user/unban/`, { id: userId }, function() {
            location.reload();
        });
    }
}

function verifyUser(userId) {
    if (confirm('Are you sure you want to verify this user? This will mark their account as verified.')) {
        ajaxPost(`/admin/api/user/verify/`, { id: userId }, function() {
            location.reload();
        });
    }
}

// Bulk operations
function bulkVerify() {
    const selectedUsers = $('.user-checkbox:checked').map(function() {
        return this.value;
    }).get();

    if (selectedUsers.length === 0) {
        showToast('No users selected', 'warning');
        return;
    }

    if (confirm(`Verify ${selectedUsers.length} selected user(s)?`)) {
        ajaxPost(`/admin/api/users/bulk-verify/`, {
            ids: JSON.stringify(selectedUsers)
        }, function() {
            location.reload();
        });
    }
}

function bulkBan() {
    const selectedUsers = $('.user-checkbox:checked').map(function() {
        return this.value;
    }).get();

    if (selectedUsers.length === 0) {
        showToast('No users selected', 'warning');
        return;
    }

    if (confirm(`Ban ${selectedUsers.length} selected user(s)? They will lose access to their accounts.`)) {
        ajaxPost(`/admin/api/users/bulk-ban/`, {
            ids: JSON.stringify(selectedUsers)
        }, function() {
            location.reload();
        });
    }
}

function clearSelection() {
    $('.user-checkbox, #select-all').prop('checked', false);
    updateBulkActionsVisibility();
}

// Export function
function exportUsers() {
    const url = `/admin/api/export/users/csv/?${new URLSearchParams({
        status: 'all',
        format: 'detailed'
    })}`;

    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = url;
    link.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('Export started. Download will begin shortly.', 'info');
}

// Search and filter functions
function filterUsers(type) {
    const table = $('#users-table').DataTable();
    if (type === 'all') {
        table.search('').columns().search('').draw();
    } else {
        table.column(4).search(type, true, false).draw(); // Type column
    }
}

function searchUsers(query) {
    $('#users-table').DataTable().search(query).draw();
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        $('.dataTables_filter input').focus();
    }

    // Ctrl/Cmd + A to select all
    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        $('#select-all').prop('checked', true).trigger('change');
    }
});
</script>
{% endblock %}
